<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Multi Flight Formatter</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #008080; /* Classic Windows 95 teal desktop */
      font-family: "MS Sans Serif", Tahoma, Geneva, sans-serif;
      color: black;
    }
    a {
      color: black;
      text-decoration: none;
    }
    a:hover {
      color: #0000cd;
    }
    /* ===============================================
       NAVIGATION BAR
    =============================================== */
    nav {
      background-color: #c0c0c0;
      border-bottom: 2px solid #7d7d7d;
      padding: 2px 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap; /* Allow wrapping on small screens */
    }
    nav ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      gap: 4px;
      flex-wrap: wrap; /* Allow wrapping */
    }
    nav a {
      padding: 2px 6px;
      border: 2px outset #fff;
      font-size: 12px;
      text-transform: uppercase;
      color: black;
      text-decoration: none;
      white-space: nowrap; /* Prevent nav links breaking */
    }
    nav a:hover {
      border: 2px inset #7d7d7d;
    }
    .theme-switch {
      font-size: 12px;
    }
    /* ===============================================
       MAIN CONTAINER (Windows 95 Window)
    =============================================== */
    .container {
      width: 800px;
      max-width: 95%; /* Prevent overflow on smaller screens */
      margin: 40px auto;
      border: 2px solid #7d7d7d;
      background-color: #fff;
      box-shadow: 2px 2px 0 #fff;
    }
    .title-bar {
      background: linear-gradient(to right, #000080, #0000cd);
      color: white;
      padding: 2px 6px;
      font-size: 14px;
      font-weight: bold;
      border-bottom: 2px solid #7d7d7d;
    }
    .window-content {
      padding: 8px;
    }
    /* H1 is structurally important but visually integrated elsewhere */
    h1 { font-size: 1px; height: 1px; width: 1px; position: absolute; overflow: hidden; } /* Visually hide but keep for screen readers */

    /* ===============================================
       FORM ELEMENTS & BUTTONS
    =============================================== */
    label {
      display: block;
      margin-bottom: 4px;
      font-size: 10px;
      font-weight: bold;
    }
    textarea, input[type="text"], input[type="date"], input[type="time"] {
      box-sizing: border-box; /* Include padding and border in width */
      width: 98%; /* Adjust width slightly */
      padding: 4px;
      margin-bottom: 8px;
      border: 2px inset #7d7d7d;
      font-size: 12px;
      font-family: "MS Sans Serif", Tahoma, Geneva, sans-serif;
      background-color: white; /* Ensure background for inputs */
    }
    textarea {
       min-height: 80px; /* Give textarea some default height */
    }
    button {
      padding: 4px 8px;
      margin: 4px 4px 4px 0;
      background-color: #c0c0c0;
      border: 2px outset #fff;
      font-size: 12px;
      text-transform: uppercase;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      border: 2px inset #7d7d7d;
    }
    select {
      padding: 4px 8px;
      margin: 4px 4px 4px 0;
      border: 2px inset #7d7d7d;
      font-size: 12px;
      font-family: "MS Sans Serif", Tahoma, Geneva, sans-serif;
      text-transform: uppercase;
      cursor: pointer;
      background-color: white; /* Ensure background for selects */
    }
    /* ===============================================
       Aircraft Selection Checkboxes (for Service Type D)
    =============================================== */
    #aircraftSelection {
      margin-bottom: 8px;
      font-size: 12px;
    }
    #aircraftSelection label {
      margin-right: 10px;
      font-weight: normal; /* Make checkbox labels normal weight */
      display: inline; /* Display labels inline */
    }
    #aircraftSelection input[type="checkbox"] {
        width: auto; /* Don't force checkboxes full width */
        margin-right: 4px;
    }

    /* ===============================================
       OUTPUT & GROUP STYLES
    =============================================== */
    .output-container {
      margin-top: 10px; /* Reduced margin */
      padding: 8px;
      border: 2px dashed #7d7d7d;
      background-color: #f0f0f0; /* Slightly off-white background */
      font-size: 12px;
      font-family: monospace; /* Use monospace for SCR output */
      color: #000080;
      white-space: pre-wrap; /* Keep whitespace */
      word-wrap: break-word; /* Allow long lines to break */
      max-height: 400px;
      overflow-y: auto;
      position: relative;
    }
    .error, .success {
      text-align: center;
      padding: 4px;
      margin-bottom: 8px;
      font-size: 12px;
      display: none; /* Hidden by default */
      border: 1px solid black;
    }
    .error {
      background-color: #ff4c4c;
      color: white;
    }
    .success {
      background-color: #4caf50;
      color: white;
    }
    .scr-group {
      border: 2px solid #7d7d7d;
      padding: 4px;
      margin-bottom: 8px;
      background-color: #fff;
    }
    .heading {
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 4px;
      color: #000080;
      text-transform: uppercase;
    }
    .send-button-container {
      display: flex;
      justify-content: flex-end;
      margin-top: 4px;
      gap: 4px; /* Add gap between buttons */
    }
    .send-button-container button {
      padding: 2px 6px;
      font-size: 10px;
    }

    /* Styles for Editable R-Lines */
     .modified-scr-row {
        border: 1px solid #ccc;
        padding: 4px;
        margin-bottom: 4px;
        background-color: #f8f8f8;
        display: flex; /* Use flexbox for alignment */
        flex-wrap: wrap; /* Allow wrapping on small screens */
        gap: 8px; /* Add spacing between elements */
        align-items: center; /* Align items vertically */
      }
      .modified-scr-row label {
        font-weight: normal; /* Normal weight for labels inside */
        font-size: 11px; /* Slightly smaller font */
        display: flex; /* Use flex for label+input alignment */
        align-items: center;
        margin-bottom: 0; /* Remove bottom margin */
        white-space: nowrap; /* Prevent label text wrapping */
      }
      .modified-scr-row input[type="text"],
      .modified-scr-row input[type="date"],
      .modified-scr-row input[type="time"],
      .modified-scr-row select {
        width: auto; /* Let inputs size naturally or set specific widths */
        padding: 2px;
        font-size: 11px;
        margin-bottom: 0; /* Remove bottom margin */
        border: 1px inset #7d7d7d; /* Simpler border */
        flex-grow: 1; /* Allow inputs to grow slightly */
        min-width: 50px; /* Minimum width */
      }
      /* Specific widths for better control */
      .modified-scr-row input.r-flight { flex-grow: 0; width: 70px; }
      .modified-scr-row input.r-date { flex-grow: 0; width: 110px; }
      .modified-scr-row input.r-day { flex-grow: 0; width: 70px; background-color: #e0e0e0; } /* Indicate disabled */
      .modified-scr-row input.r-opcode { flex-grow: 0; width: 80px; }
      .modified-scr-row input.r-time { flex-grow: 0; width: 70px; }
      .modified-scr-row input.r-airport { flex-grow: 0; width: 60px; text-transform: uppercase; }
      .modified-scr-row select.r-service { flex-grow: 0; width: 50px; }


    /* ===============================================
       RESPONSIVE ADJUSTMENTS
    =============================================== */
    @media (max-width: 850px) { /* Adjusted breakpoint */
      .container {
        width: 95%; /* Use more width on smaller screens */
      }
       /* Make R-line fields stack more gracefully */
       .modified-scr-row {
          /* Adjust gap or wrap settings if needed */
       }
    }
     @media (max-width: 600px) {
      nav ul {
        /* Keep flex-wrap: wrap from base style */
         justify-content: flex-start;
      }
      nav a {
          /* display: block; Make nav links block level */
          /* width: 95%; Make them take most of the width */
          /* margin-bottom: 2px; */
      }
       .modified-scr-row {
          flex-direction: column; /* Stack elements vertically */
          align-items: stretch; /* Stretch items full width */
       }
       .modified-scr-row label {
           width: 100%; /* Make labels take full width */
           justify-content: space-between; /* Space label text and input */
           margin-bottom: 4px; /* Add space between stacked rows */
       }
       .modified-scr-row input, .modified-scr-row select {
           width: auto; /* Let flexbox handle width */
           min-width: 100px; /* Ensure inputs aren't too small */
       }
    }

    /* Footer */
    footer {
      font-family: "MS Sans Serif", Tahoma, sans-serif;
      font-size: 12px;
      color: black;
      text-align: center;
      margin-top: 20px;
      padding-bottom: 20px; /* Add padding at the bottom */
    }
  </style>
</head>
<body>
  <!-- NAVIGATION BAR -->
  <nav>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="multiflight.html">Multi Flight</a></li>
      <li><a href="airport-search.html">Airport Database</a></li>
      <li><a href="historic-log.html">Historic Log</a></li>
      <li><a href="gcrformat.html">GCR Format</a></li>
      <li><a href="turnaround.html">Turnaround Format</a></li>
      <li><a href="quicklinks.html">Quick Links</a></li>
      <li><a href="https://forms.gle/nXCQzWxCcH5B1uZd6" target="_blank" rel="noopener noreferrer">Log Issues</a></li>
    </ul>
  </nav>

  <!-- MAIN CONTAINER (Styled as a Windows 95 window) -->
  <div class="container">
    <div class="title-bar">Multi Flight Formatter</div>
    <div class="window-content">
      <!-- Visually hidden H1 for accessibility -->
      <h1>Multi Flight Formatter</h1>

      <!-- Error and Success Messages -->
      <div id="errorMessage" class="error"></div>
      <div id="successMessage" class="success"></div>

      <!-- User Inputs -->
      <label for="userInput">Flight Information (One per line):</label>
      <textarea id="userInput" placeholder="Example: FR123 LHR DUB 01JAN2024 1000 1100 J 73H&#10;Paste legs here. Format: FLIGHT FROM TO DATE DEP_TIME ARR_TIME CODE [AIRCRAFT_TYPE] (Aircraft type optional)"></textarea>

      <label for="regInput">Aircraft Registration (for non-D service types or specific overrides):</label>
      <input type="text" id="regInput" placeholder="ENTER REGISTRATION (e.g., EI-XXX or L45/CL5 for type D)" />

      <!-- Aircraft selection for Service Type 'D' -->
      <div id="aircraftSelection" style="display: none;">
        <span>Select Aircraft Type for 'D' Service:</span><br>
        <label><input type="checkbox" id="learjetCheckbox" name="aircraftType" checked> Learjet (L45)</label>
        <label><input type="checkbox" id="bombardierCheckbox" name="aircraftType"> Bombardier (CL5)</label>
      </div>

      <!-- Action Buttons and Dropdowns -->
      <div>
        <button id="formatBtn">Format SCR Messages</button>
        <select id="slotType" title="Select Slot Type">
          <option value="NEW">NEW SLOT</option>
          <option value="CANCEL">CANCEL SLOT</option>
          <option value="CHANGE">CHANGE SCR</option>
        </select>
        <select id="dropdownMenu" title="Select Flight Service Type">
          <option value="P" title="Non-revenue flight">P</option>
          <option value="D" title="General Aviation">D</option>
          <option value="K" title="Training flight">K</option>
          <option value="T" title="Technical test/ferry">T</option> <!-- Clarified T -->
          <option value="J" title="Revenue (passenger)">J</option>
          <option value="X" title="Military/State/Other">X</option> <!-- Clarified X -->
        </select>
        <button id="sendAllBtn">Send All Emails</button>
      </div>

      <!-- Output List -->
      <div id="outputList"></div>
    </div>
  </div>

  <footer>Created By: ArtemisByte</footer>

  <!-- Load Firebase libraries -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <!-- Load Firebase configuration (ensure firebase.js exists in scripts/ folder) -->
  <script src="scripts/firebase.js"></script>

<!-- Multiflight Script - UPDATED PREFIX/OPCODE LOGIC for J & P -->
<script>
    // Ensure Firebase is initialized
    if (typeof firebase === 'undefined') {
       showError("Firebase configuration failed to load. Airport email lookup will not work.");
       // Optionally disable features relying on Firebase
    }

    // --- Constants and Global State ---
    const STORAGE_KEY = "historicLog";
    let currentSlotType = ""; // Stores the selected slot type globally for email subjects etc.
    const monthMap = { JAN: 0, FEB: 1, MAR: 2, APR: 3, MAY: 4, JUN: 5, JUL: 6, AUG: 7, SEP: 8, OCT: 9, NOV: 10, DEC: 11 };
    const monthAbbrArr = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];

    // --- Firebase Email Lookup ---
    async function getAirportEmail(airportCode, serviceType) {
      // Check if Firebase is available
      if (typeof firebase === 'undefined' || typeof firebase.database !== 'function') {
          console.error("Firebase is not initialized. Returning default email.");
          return "slotdesk@ryanair.com";
      }
      try {
        const snapshot = await firebase.database().ref("airports/" + airportCode.toUpperCase()).once("value");
        if (snapshot.exists()) {
          const data = snapshot.val();
          const cleanServiceType = serviceType.trim().toUpperCase();
          // Prefer specific email if available, otherwise fallback
          if (cleanServiceType === "D") {
             return data.emailGeneral?.trim() || data.email?.trim() || "slotdesk@ryanair.com";
          } else {
             return data.email?.trim() || "slotdesk@ryanair.com";
          }
        } else {
          console.warn(`No email data found in Firebase for airport: ${airportCode}`);
          return "slotdesk@ryanair.com"; // Default if airport not found
        }
      } catch (error) {
        console.error("Error fetching email from Firebase for " + airportCode + ":", error);
        showError(`Firebase lookup failed for ${airportCode}. Using default email.`); // Show error to user
        return "slotdesk@ryanair.com"; // Default on error
      }
    }

    // --- Historic Log Management ---
    function getHistoricLog() {
      try {
          const logData = localStorage.getItem(STORAGE_KEY);
          return logData ? JSON.parse(logData) : [];
      } catch (e) {
          console.error("Error reading historic log from localStorage:", e);
          return []; // Return empty array on error
      }
    }
    function setHistoricLog(logEntries) {
      try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(logEntries));
      } catch (e) {
          console.error("Error saving historic log to localStorage:", e);
          showError("Could not save to historic log (localStorage might be full).");
      }
    }
    function addLogEntry(entry) {
      const logEntries = getHistoricLog();
      logEntries.push(entry);
      setHistoricLog(logEntries);
      console.log("Log entry added:", entry);
    }

    // --- Date and Time Helpers ---

    /**
     * Parses a date string (DDMON or DDMONYYYY) into a Date object.
     * Returns null if the format is invalid.
     * Assumes current year if year is not provided.
     */
    function parseDateString(dateStr) {
        dateStr = dateStr.toUpperCase();
        const matchDDMON = dateStr.match(/^(\d{2})([A-Z]{3})$/); // e.g., 01JAN
        const matchDDMONYYYY = dateStr.match(/^(\d{2})([A-Z]{3})(\d{4})$/); // e.g., 01JAN2024

        let day, monthAbbr, year;

        if (matchDDMONYYYY) {
            day = parseInt(matchDDMONYYYY[1], 10);
            monthAbbr = matchDDMONYYYY[2];
            year = parseInt(matchDDMONYYYY[3], 10);
        } else if (matchDDMON) {
            day = parseInt(matchDDMON[1], 10);
            monthAbbr = matchDDMON[2];
            year = new Date().getFullYear(); // Assume current year
        } else {
            return null; // Invalid format
        }

        const monthIndex = monthMap[monthAbbr];
        if (monthIndex === undefined || isNaN(day) || isNaN(year) || day < 1 || day > 31) {
            return null; // Invalid month or day
        }

        // Use UTC to prevent timezone offsets from changing the date
        const dateObj = new Date(Date.UTC(year, monthIndex, day));
        if (dateObj.getUTCFullYear() === year && dateObj.getUTCMonth() === monthIndex && dateObj.getUTCDate() === day) {
           return dateObj;
        } else {
           return null; // Invalid date (e.g., Feb 31st)
        }
    }

function getDayOfOperation(dayOfWeek) {
      // Normalize input day name
      const formattedDay = dayOfWeek.charAt(0).toUpperCase() + dayOfWeek.slice(1).toLowerCase();
      const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
      const digits = [7, 1, 2, 3, 4, 5, 6];
      const powers = [0, 6, 5, 4, 3, 2, 1];

      // Find the index of the day, default to Monday (index 1) if not found
      let index = days.indexOf(formattedDay);
      if (index === -1) {
        console.warn(`getDayOfOperation: Unknown day "${dayOfWeek}", defaulting to Monday.`);
        index = 1; // Default to Monday
      }
      
      const digit = digits[index];
      const power = powers[index];
      const codeNum = digit * Math.pow(10, power);
      const codeStr = String(codeNum).padStart(7, '0');
      return codeStr;
    }

      function convertSCRDateToInput(scrDate) {
      const parsed = parseDateString(scrDate);
      if (!parsed) return "";
      const day = String(parsed.getUTCDate()).padStart(2, '0');
      const month = String(parsed.getUTCMonth() + 1).padStart(2, '0');
      const year = parsed.getUTCFullYear();
      return `${year}-${month}-${day}`;
    }

     function convertInputDateToSCR(inputDate) {
      try {
          const dateObj = new Date(inputDate + 'T00:00:00Z'); // Use UTC
          if (isNaN(dateObj.getTime())) return "01JAN";
          const day = String(dateObj.getUTCDate()).padStart(2, '0');
          const monthAbbr = monthAbbrArr[dateObj.getUTCMonth()];
          return day + monthAbbr;
      } catch (e) {
          console.error("Error converting input date:", e);
          return "01JAN";
      }
    }

     /** Gets current date as DDMON */
    function getCurrentDate() {
        const dateObj = new Date();
        const day = String(dateObj.getDate()).padStart(2, '0');
        const month = monthAbbrArr[dateObj.getMonth()];
        return `${day}${month}`;
    }

    // --- Input Parsing and Validation ---
    function parseInput(input) {
      const lines = input.trim().split("\n");
      const parsedEntries = [];
      const errors = [];

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;

        const parts = line.split(/\s+/);

        if (parts.length < 7 || parts.length > 8) {
          errors.push(`Line ${i + 1}: Invalid format (expected 7 or 8 parts) - "${line}"`);
          continue;
        }

        const flightRaw = parts[0];
        const from = parts[1].toUpperCase();
        const to = parts[2].toUpperCase();
        const dateStr = parts[3];
        const departureTime = parts[4];
        const arrivalTime = parts[5];
        const code = parts[6].toUpperCase(); // Service Type (used ONLY for context, not direct SCR field)
        // Aircraft type from input (optional 8th field)
        let aircraftTypeInput = (parts.length === 8) ? parts[7].toUpperCase() : null;

        // Normalize common aircraft inputs immediately
        if (aircraftTypeInput === '738') aircraftTypeInput = '73H'; // Treat 738 as 73H internally early
        if (aircraftTypeInput === '197') aircraftTypeInput = '7M8'; // Treat 197 as 7M8 internally early
        if (aircraftTypeInput === '73M') aircraftTypeInput = '7M8'; // Treat 73M as 7M8 internally early


        const parsedDate = parseDateString(dateStr);
        if (!parsedDate) {
          errors.push(`Line ${i + 1}: Invalid date format "${dateStr}" - "${line}"`);
          continue;
        }

        if (!/^\d{4}$/.test(departureTime) || !/^\d{4}$/.test(arrivalTime)) {
             errors.push(`Line ${i + 1}: Invalid time format (must be 4 digits HHMM) - "${line}"`);
             continue;
        }

        const dayOfWeek = parsedDate.toLocaleDateString("en-US", { weekday: "long", timeZone: "UTC" });
        const dayOfOperation = getDayOfOperation(dayOfWeek);
        const date = convertInputDateToSCR(parsedDate.toISOString().split('T')[0]);

        const flightPrefix = flightRaw.slice(0, 2).toUpperCase();
        let flightNumber = flightRaw.slice(2);
        const flightDigits = flightNumber.match(/\d+/)?.[0] || "";
        let flightLetters = flightNumber.replace(/\d+/g, "").toUpperCase();
        if (flightLetters.endsWith("P")) {
          flightLetters = flightLetters.slice(0, -1);
        }
        const paddedFlightDigits = flightDigits.padStart(3, "0");
        const flight = `${flightPrefix}${paddedFlightDigits}${flightLetters}`;

        parsedEntries.push({
          flight, from, to, date, fullDate: parsedDate,
          departureTime, arrivalTime,
          // 'code' here is the *input* service type (J,P,D...), used for logic
          serviceTypeInput: code,
          dayOfOperation,
          // Store the potentially normalized aircraft type from input
          aircraftTypeInput: aircraftTypeInput,
          originalLine: line
        });
      }

      return { parsedEntries, errors };
    }

    // --- Getters for Form Values ---
    function getSelectedServiceType() {
      // This is the service type selected from the dropdown, which dictates the *actual* service type in the SCR line
      return document.getElementById("dropdownMenu").value;
    }
    function getSlotType() {
      const val = document.getElementById("slotType").value;
      if (val === "NEW") return "NEW SLOT";
      if (val === "CANCEL") return "CANCEL SLOT";
      if (val === "CHANGE") return "CHANGE SCR";
      return "";
    }
    /** Gets Aircraft Registration based on Service Type and Input */
    function getAircraftReg() {
      const selectedServiceType = getSelectedServiceType(); // From dropdown
      const regInputVal = document.getElementById("regInput").value.trim().toUpperCase();

      if (selectedServiceType === "D") {
         if (regInputVal && regInputVal !== "L45" && regInputVal !== "CL5") {
             return regInputVal; // Specific reg takes precedence
         } else { // Use checkboxes if input is empty or default type codes
             if (document.getElementById("learjetCheckbox").checked) return "L45";
             if (document.getElementById("bombardierCheckbox").checked) return "CL5";
             document.getElementById("learjetCheckbox").checked = true; // Fallback
             return "L45";
         }
      } else {
        return regInputVal || "[UNKNOWN_REG]"; // Use input or placeholder
      }
    }

    /**
     * Determines the final combined code field (Prefix + OpCode) for the SCR line.
     * Uses the actual SCR line service type (from dropdown) and aircraft type from input.
     */
    function getFinalCombinedCode(scrLineServiceType, aircraftTypeInput) {
        const serviceType = scrLineServiceType.toUpperCase(); // Use the type for the SCR line
        const acTypeInput = aircraftTypeInput ? aircraftTypeInput.toUpperCase() : null;

        if (serviceType === 'J') {
            // For J, prefix depends on input aircraft type
            if (acTypeInput === '73H') return '18973H'; // Treat input 738 as 73H (normalized in parseInput)
            if (acTypeInput === '7M8') return '1977M8'; // Treat input 197/73M as 7M8
            return '18973H'; // Default for J if no input or other input
        }
        else if (serviceType === 'P') {
            // For P, prefix is always 000, OpCode depends on input
            if (acTypeInput === '73H') return '00073H';
            if (acTypeInput === '7M8') return '0007M8';
            return '00073H'; // Default for P if no input or other input
        }
        else if (serviceType === 'D') {
            // For D, determined by checkboxes/reg input, not aircraftTypeInput field usually
            // Prefix (seat count)
            const prefix = document.getElementById("bombardierCheckbox").checked ? "009" : "008";
            // OpCode (aircraft type)
            const opCode = document.getElementById("bombardierCheckbox").checked ? "CL5" : "L45"; // Assuming CL5 for Bombardier
             // Check if specific registration was entered that isn't L45/CL5 - logic might need refinement if reg overrides type code
             // For now, assume checkboxes dictate the combined code for D
             return prefix + opCode;
        }
        else { // For K, T, X, etc. - Prefix is 000
            const prefix = '000';
            // Determine OpCode based on input or default
            let opCode = '73H'; // Default aircraft type
            if (acTypeInput === '73H') opCode = '73H';
            else if (acTypeInput === '7M8') opCode = '7M8';
            // Add other specific aircraft type mappings here if needed
            // else if (acTypeInput === 'SOME_OTHER_CODE') opCode = 'SOME_OTHER_CODE';
            return prefix + opCode;
        }
    }


    // --- UI Feedback ---
    function showError(message) {
      const errorDiv = document.getElementById("errorMessage");
      errorDiv.innerHTML = message; // Allow HTML like <br>
      errorDiv.style.display = "block";
    }
    function showSuccess(message) {
      const successDiv = document.getElementById("successMessage");
      successDiv.textContent = message;
      successDiv.style.display = "block";
      setTimeout(() => { successDiv.style.display = "none"; }, 5000); // Keep timeout relatively short
    }
    function clearFeedback() {
        document.getElementById("errorMessage").style.display = "none";
        document.getElementById("errorMessage").innerHTML = "";
        document.getElementById("successMessage").style.display = "none";
        document.getElementById("successMessage").textContent = "";
    }

    // --- Core Logic: Format, Display, Send ---

    /** Attaches click listeners to dynamically created "Send Email" buttons */
    function attachSendButtonsListeners() {
      const outputList = document.getElementById("outputList");
      outputList.removeEventListener("click", handleOutputListClick); // Prevent duplicates
      outputList.addEventListener("click", handleOutputListClick);
    }

    /** Handles clicks within the output list (delegated) */
    async function handleOutputListClick(event) {
       const target = event.target;
       // Check if the clicked element is a Send button for NEW/CANCEL
       if (target.tagName === 'BUTTON' && target.closest('.scr-group') && target.textContent.includes('Send Email')) {
            const scrGroup = target.closest('.scr-group');
            // Check if it's NOT the 'Update & Send Email' button from the CHANGE SCR UI
            if (!target.textContent.includes('Update')) {
                const airportCode = scrGroup.dataset.airportCode;
                const scrOutput = scrGroup.dataset.scrOutput; // Retrieve stored SCR message
                if (airportCode && scrOutput) {
                   // Use the global currentSlotType for individual sends too
                   await sendEmail(airportCode, scrOutput);
                } else {
                   console.error("Could not find airport code or SCR output on group for sending email.");
                   showError("Error sending email: Missing data.");
                }
            }
       }
    }

    /** Formats SCR messages for NEW or CANCEL requests */
    function formatSCRMessages() {
      clearFeedback();
      const input = document.getElementById("userInput").value;
      const { parsedEntries, errors } = parseInput(input);

      if (errors.length > 0) {
        showError(`Input validation failed:<br>${errors.join('<br>')}`);
      }
       if (parsedEntries.length === 0 && errors.length === 0) {
        showError("No valid flight entries found to format.");
        return;
      }
      if(parsedEntries.length === 0 && errors.length > 0){ return; }


      currentSlotType = getSlotType(); // SET GLOBAL SLOT TYPE FOR SUBJECTS
      const scrLineServiceType = getSelectedServiceType(); // Get the service type selected in the dropdown for the SCR line
      const globalReg = getAircraftReg(); // Get registration (mainly for SI line comments)
      const outputList = document.getElementById("outputList");
      outputList.innerHTML = "";

      const airportGroups = {};
      parsedEntries.forEach((data) => {
        const { from, to } = data;
        if (!airportGroups[from]) airportGroups[from] = { airportCode: from, flights: [] };
        airportGroups[from].flights.push({ type: 'departure', data });
        if (!airportGroups[to]) airportGroups[to] = { airportCode: to, flights: [] };
        airportGroups[to].flights.push({ type: 'arrival', data });
      });

      Object.values(airportGroups).forEach((group) => {
        const { airportCode, flights } = group;
        const scrLines = [];
        scrLines.push("SCR");
        scrLines.push("S25");
        scrLines.push(getCurrentDate());
        scrLines.push(airportCode);

        flights.forEach(flightEntry => {
          const { type, data } = flightEntry;
          const { flight, date, dayOfOperation, departureTime, arrivalTime, from, to, aircraftTypeInput } = data; // Use aircraftTypeInput

          const flightStatus = (currentSlotType === "CANCEL SLOT") ? "D" : "N";

          // **NEW LOGIC: Get the final combined code based on SCR line type and input AC type**
          const finalCombinedCode = getFinalCombinedCode(scrLineServiceType, aircraftTypeInput);

          // Construct N/D lines using template literals with correct spaces and the new combined code
          let line;
          if (type === 'departure') {
            line = `${flightStatus} ${flight} ${date}${date} ${dayOfOperation} ${finalCombinedCode} ${departureTime}${to} ${scrLineServiceType}`; // Use scrLineServiceType
          } else { // arrival
            line = `${flightStatus}${flight} ${date}${date} ${dayOfOperation} ${finalCombinedCode} ${from}${arrivalTime} ${scrLineServiceType}`; // Use scrLineServiceType
          }
          scrLines.push(line);
        });

        // Construct SI line using template literals with spaces
        let siLineAction = (currentSlotType === "NEW SLOT") ? "NEW SLOT REQ" : "SLOT CANX REQ";
        let siLine = `SI ${siLineAction} ${airportCode}`;
         if (scrLineServiceType === "D") { // Check dropdown selection
            let aircraftTypeLabel = document.getElementById("learjetCheckbox").checked ? "LEARJET" : "BOMBARDIER";
             siLine += ` // ${aircraftTypeLabel} REG: ${globalReg}`; // globalReg calculated based on D type logic
        }
        scrLines.push(siLine);

        const scrOutput = scrLines.join("\n");
        createScrGroupElement(outputList, airportCode, scrOutput);

        // Log the generated message
        const combinedFlightNumbers = flights.map(e => e.data.flight).join(", ");
        const combinedDirections = flights.map(e => e.type).join("/");
        addLogEntry({
          type: currentSlotType,
          flightNumber: combinedFlightNumbers, airport: airportCode,
          direction: combinedDirections, timestamp: new Date().toISOString().split(".")[0].replace("T", " "),
          scrMessage: scrOutput
        });
      });

       if (parsedEntries.length > 0 && errors.length === 0) {
          showSuccess(`Formatted ${parsedEntries.length} flight leg(s) into ${Object.keys(airportGroups).length} SCR message(s).`);
       } else if (parsedEntries.length > 0 && errors.length > 0) {
           showSuccess(`Formatted ${parsedEntries.length} valid flight leg(s). Some input lines had errors (see above).`);
       }
      attachSendButtonsListeners();
    }

     /** Formats SCR messages for CHANGE requests with editable R-lines */
    function formatChangeSCRMessages() {
        clearFeedback();
        const input = document.getElementById("userInput").value;
        const { parsedEntries, errors } = parseInput(input);

         if (errors.length > 0) {
            showError(`Input validation failed:<br>${errors.join('<br>')}`);
         }
         if (parsedEntries.length === 0 && errors.length === 0) {
            showError("No valid flight entries found to format for change request.");
            return;
         }
          if(parsedEntries.length === 0 && errors.length > 0){ return; }

        currentSlotType = "CHANGE SCR"; // SET GLOBAL SLOT TYPE FOR SUBJECTS
        const scrLineServiceType = getSelectedServiceType(); // Get service type from dropdown for this format run
        const globalReg = getAircraftReg(); // Get reg based on dropdown type
        const outputList = document.getElementById("outputList");
        outputList.innerHTML = "";

        const airportGroups = {};
        parsedEntries.forEach((data) => {
            const { from, to } = data;
            if (!airportGroups[from]) airportGroups[from] = { airportCode: from, flights: [] };
            airportGroups[from].flights.push({ type: 'departure', data });
            if (!airportGroups[to]) airportGroups[to] = { airportCode: to, flights: [] };
            airportGroups[to].flights.push({ type: 'arrival', data });
        });

        Object.values(airportGroups).forEach((group, groupIndex) => {
            const { airportCode, flights } = group;

            let headerLines = ["SCR", "S25", getCurrentDate(), airportCode];
            let cLines = [];
            let initialRLinesData = [];

            flights.forEach((flightEntry, flightIndex) => {
                const { type, data } = flightEntry;
                const { flight, date, dayOfOperation, departureTime, arrivalTime, from, to, aircraftTypeInput } = data; // Use aircraftTypeInput

                // **NEW LOGIC: Get final combined code for C-line**
                const finalCombinedCode = getFinalCombinedCode(scrLineServiceType, aircraftTypeInput);

                let cLineBase = `${date}${date} ${dayOfOperation} ${finalCombinedCode}`; // Use new combined code
                let cLine;

                // Data for the editable R-line row
                let rLineData = {
                    id: `rline-${groupIndex}-${flightIndex}`, flight,
                    date: convertSCRDateToInput(date), day: dayOfOperation,
                    // Store the combined code for the input field
                    combinedCode: finalCombinedCode,
                    // Store the service type from the dropdown used for this row initially
                    service: scrLineServiceType,
                    direction: type
                };

                if (type === 'departure') {
                    cLine = `C ${flight} ${cLineBase} ${departureTime}${to} ${scrLineServiceType}`; // Use dropdown service type
                    rLineData.time = departureTime.slice(0, 2) + ":" + departureTime.slice(2);
                    rLineData.airport = to;
                } else { // arrival
                    cLine = `C${flight} ${cLineBase} ${from}${arrivalTime} ${scrLineServiceType}`; // Use dropdown service type
                    rLineData.time = arrivalTime.slice(0, 2) + ":" + arrivalTime.slice(2);
                    rLineData.airport = from;
                }
                cLines.push(cLine);
                initialRLinesData.push(rLineData);
            });

            // --- Create UI Elements ---
            const scrGroup = document.createElement("div");
            scrGroup.classList.add("scr-group");
            scrGroup.dataset.airportCode = airportCode;
            scrGroup.dataset.headerLines = JSON.stringify(headerLines);
            scrGroup.dataset.cLines = JSON.stringify(cLines);
            scrGroup.dataset.siAction = "SLOT CHG REQ";
            scrGroup.dataset.siAirport = airportCode;
            // Store context needed for SI line details and R-line reconstruction
            scrGroup.dataset.globalReg = globalReg;
            scrGroup.dataset.serviceType = scrLineServiceType; // Store dropdown service type used for this group
            scrGroup.dataset.initialRLinesData = JSON.stringify(initialRLinesData);

            const headingDiv = document.createElement("div");
            headingDiv.classList.add("heading");
            headingDiv.textContent = `Change SCR [${airportCode}]`;

            const nonEditableDiv = document.createElement("div");
            nonEditableDiv.style.whiteSpace = "pre-wrap";
            nonEditableDiv.style.fontFamily = 'monospace';
            nonEditableDiv.style.marginBottom = '10px';
            nonEditableDiv.innerHTML = `<strong>--- Header &amp; Cancellation (C) Lines ---</strong>\n${headerLines.join("\n")}\n${cLines.join("\n")}`;

            const editableDiv = document.createElement("div");
            editableDiv.id = `editable-r-lines-${groupIndex}`;
            editableDiv.innerHTML = `<strong style="display: block; margin-bottom: 4px;">--- New Request (R) Lines (Editable) ---</strong>`;
            initialRLinesData.forEach((rowData) => {
                // Pass combinedCode to the row creation function
                editableDiv.appendChild(createEditableRLineRow(rowData));
            });

            const siDiv = document.createElement("div");
            siDiv.id = `si-line-display-${groupIndex}`;
            siDiv.style.whiteSpace = "pre-wrap";
            siDiv.style.fontFamily = 'monospace';
            siDiv.style.marginTop = '10px';
            let initialSiLine = `SI SLOT CHG REQ ${airportCode}`; // Use space
             if (scrLineServiceType === "D") { // Check dropdown selection
                 let aircraftTypeLabel = document.getElementById("learjetCheckbox").checked ? "LEARJET" : "BOMBARDIER";
                 initialSiLine += ` // ${aircraftTypeLabel} REG: ${globalReg}`; // Use reg calculated for D
             }
            siDiv.innerHTML = `<strong>--- SI Line ---</strong>\n${initialSiLine}`;

            const outputDiv = document.createElement("div");
            outputDiv.classList.add("output-container");
            outputDiv.appendChild(nonEditableDiv);
            outputDiv.appendChild(editableDiv);
            outputDiv.appendChild(siDiv);

            const updateSendBtn = document.createElement("button");
            updateSendBtn.textContent = "Update & Send Email";
            updateSendBtn.addEventListener("click", async () => {
                const updatedRLines = [];
                const editableContainer = document.getElementById(`editable-r-lines-${groupIndex}`);
                const modifiedRows = editableContainer.querySelectorAll(".modified-scr-row");
                let reconstructionError = false;

                const storedInitialRLinesData = JSON.parse(scrGroup.dataset.initialRLinesData || "[]");
                const groupServiceType = scrGroup.dataset.serviceType; // Original dropdown type
                const groupGlobalReg = scrGroup.dataset.globalReg; // Original reg

                modifiedRows.forEach((rowDiv) => {
                    const rowId = rowDiv.dataset.rowId;
                    const initialData = storedInitialRLinesData.find(d => d.id === rowId);
                    if (!initialData) { reconstructionError = true; return; }
                    const direction = initialData.direction;

                    try {
                        const flightVal = rowDiv.querySelector(".r-flight").value.toUpperCase();
                        const dateVal = rowDiv.querySelector(".r-date").value;
                        const scrDate = convertInputDateToSCR(dateVal);
                        const dayVal = rowDiv.querySelector(".r-day").value;
                        // **Read the potentially modified combined code**
                        const combinedCodeVal = rowDiv.querySelector(".r-combined-code").value.toUpperCase();
                        const timeValRaw = rowDiv.querySelector(".r-time").value;
                        const timeVal = timeValRaw.replace(":", "");
                        const airportVal = rowDiv.querySelector(".r-airport").value.toUpperCase();
                        // **Get the potentially modified service type for this specific R-line**
                        const serviceVal = rowDiv.querySelector(".r-service").value.toUpperCase();

                        // Basic validation
                        if (!flightVal || !scrDate || !dayVal || !combinedCodeVal || !/^\d{4}$/.test(timeVal) || !airportVal || !serviceVal) {
                           throw new Error("Missing or invalid data in modified row.");
                        }

                        // Construct R-line using the modified values
                        let rLine;
                        if (direction === 'departure') {
                             rLine = `R ${flightVal} ${scrDate}${scrDate} ${dayVal} ${combinedCodeVal} ${timeVal}${airportVal} ${serviceVal}`; // Space after R
                        } else { // arrival
                             rLine = `R${flightVal} ${scrDate}${scrDate} ${dayVal} ${combinedCodeVal} ${airportVal}${timeVal} ${serviceVal}`; // No space after R
                        }
                        updatedRLines.push(rLine);

                    } catch (err) {
                        console.error("Error reconstructing R-line:", err, rowDiv);
                        showError(`Error in modified R-Line for flight ${initialData?.flight || 'unknown'}. Check values.`);
                        reconstructionError = true;
                    }
                });

                if (reconstructionError) {
                    showError(`Failed to update SCR for ${airportCode}. Review errors above.`);
                    return;
                }

                const storedHeader = JSON.parse(scrGroup.dataset.headerLines || "[]");
                const storedCLines = JSON.parse(scrGroup.dataset.cLines || "[]");

                // Reconstruct SI line based on original group context (dropdown type)
                const siAction = scrGroup.dataset.siAction;
                const siAirport = scrGroup.dataset.siAirport;
                let finalSiLine = `SI ${siAction} ${siAirport}`;

                if (groupServiceType === "D") { // Use original dropdown type for SI comment context
                    let currentAircraftTypeLabel = document.getElementById("learjetCheckbox").checked ? "LEARJET" : "BOMBARDIER";
                    let currentRegForD = getAircraftReg(); // Re-calculate based on current state
                    finalSiLine += ` // ${currentAircraftTypeLabel} REG: ${currentRegForD}`;
                }
                document.getElementById(`si-line-display-${groupIndex}`).innerHTML = `<strong>--- SI Line ---</strong>\n${finalSiLine}`;

                const updatedScrMessage = storedHeader.join("\n") + "\n"
                                          + storedCLines.join("\n") + "\n"
                                          + updatedRLines.join("\n") + "\n"
                                          + finalSiLine;

                scrGroup.dataset.scrOutput = updatedScrMessage;

                showSuccess(`Modified SCR updated for ${airportCode}. Triggering email...`);
                // Use the global 'currentSlotType' (set to CHANGE SCR) for the subject
                await sendEmail(airportCode, updatedScrMessage);

                 addLogEntry({
                    type: "CHANGE SCR (Updated)",
                    flightNumber: storedInitialRLinesData.map(r => r.flight).join(", "),
                    airport: airportCode,
                    direction: "change",
                    timestamp: new Date().toISOString().split(".")[0].replace("T", " "),
                    scrMessage: updatedScrMessage
                 });
            });

            const buttonContainer = document.createElement("div");
            buttonContainer.classList.add("send-button-container");
            buttonContainer.appendChild(updateSendBtn);

            scrGroup.appendChild(headingDiv);
            scrGroup.appendChild(outputDiv);
            scrGroup.appendChild(buttonContainer);
            outputList.appendChild(scrGroup);

            // Log initial state
            const initialRLinesStrings = initialRLinesData.map(row => {
                 const scrDate = convertInputDateToSCR(row.date);
                 const timeFormatted = row.time.replace(":", "");
                 if (row.direction === 'departure') {
                     // Use row.combinedCode here
                     return `R ${row.flight} ${scrDate}${scrDate} ${row.day} ${row.combinedCode} ${timeFormatted}${row.airport} ${row.service}`;
                 } else {
                     // Use row.combinedCode here
                     return `R${row.flight} ${scrDate}${scrDate} ${row.day} ${row.combinedCode} ${row.airport}${timeFormatted} ${row.service}`;
                 }
             });
             const initialScrMessage = headerLines.join("\n") + "\n"
                                    + cLines.join("\n") + "\n"
                                    + initialRLinesStrings.join("\n") + "\n"
                                    + initialSiLine;
             scrGroup.dataset.scrOutput = initialScrMessage;

            addLogEntry({
                type: "CHANGE SCR (Initial)",
                flightNumber: initialRLinesData.map(r => r.flight).join(", "),
                airport: airportCode,
                direction: "change",
                timestamp: new Date().toISOString().split(".")[0].replace("T", " "),
                scrMessage: initialScrMessage
            });

        }); // End loop through airport groups

         if (parsedEntries.length > 0 && errors.length === 0) {
            showSuccess(`Formatted ${parsedEntries.length} flight leg(s) into ${Object.keys(airportGroups).length} editable Change SCR message(s).`);
         } else if (parsedEntries.length > 0 && errors.length > 0) {
             showSuccess(`Formatted ${parsedEntries.length} valid flight leg(s) for Change SCR. Some input lines had errors (see above).`);
         }
    }

     /** Helper to create a single editable R-Line row UI - UPDATED for combinedCode */
     function createEditableRLineRow(rowData) {
        const rowDiv = document.createElement("div");
        rowDiv.classList.add("modified-scr-row");
        rowDiv.dataset.rowId = rowData.id;

        const createField = (labelText, inputType, className, value, disabled = false, options = null) => {
            const label = document.createElement("label");
            label.textContent = labelText + ": ";
            let input;
            if (inputType === 'select') {
                input = document.createElement("select");
                input.classList.add(className);
                (options || []).forEach(opt => {
                    const o = document.createElement("option");
                    o.value = opt;
                    o.textContent = opt;
                    if (opt === value) o.selected = true;
                    input.appendChild(o);
                });
            } else {
                input = document.createElement("input");
                input.type = inputType;
                input.classList.add(className);
                input.value = value;
            }
            input.disabled = disabled;
            if(disabled) input.style.backgroundColor = "#e0e0e0";
            if(inputType === 'text' && (className === 'r-airport' || className === 'r-combined-code')) { // Uppercase airport and code
                 input.style.textTransform = 'uppercase';
            }
            label.appendChild(input);
            return { label, input };
        };

        const flightField = createField("Flight", "text", "r-flight", rowData.flight);
        const dateField = createField("Date", "date", "r-date", rowData.date);
        const dayField = createField("Day", "text", "r-day", rowData.day, true);
        // **MODIFIED: Use combinedCode**
        const combinedCodeField = createField("Code (Prefix+Op)", "text", "r-combined-code", rowData.combinedCode);
        const timeField = createField("Time", "time", "r-time", rowData.time);
        const airportField = createField("Airport", "text", "r-airport", rowData.airport);
        // Service type from dropdown used initially
        const serviceField = createField("Service", "select", "r-service", rowData.service, false, ["P", "J", "T", "K", "D", "X"]);

        dateField.input.addEventListener("change", () => {
            try {
                const selectedDate = new Date(dateField.input.value + 'T00:00:00Z'); // Use UTC
                if (!isNaN(selectedDate.getTime())) {
                    const dayOfWeek = selectedDate.toLocaleDateString("en-US", { weekday: "long", timeZone: "UTC" });
                    dayField.input.value = getDayOfOperation(dayOfWeek);
                } else {
                     dayField.input.value = "INVALID";
                }
            } catch (e) {
                 console.error("Error updating day from date:", e);
                 dayField.input.value = "ERROR";
            }
        });

        // Add event listener to Service select to potentially update the combinedCode field logic (optional enhancement)
        serviceField.input.addEventListener("change", (e) => {
            const newServiceType = e.target.value;
            // You could add logic here to *suggest* a new combinedCode based on the newServiceType,
            // but for now, the user manually edits the combinedCode field.
            // Example: if newServiceType is 'J', maybe clear the combined code field or set default?
            console.log("Service type changed to:", newServiceType, "Combined code might need manual update.");
        });


        rowDiv.appendChild(flightField.label);
        rowDiv.appendChild(dateField.label);
        rowDiv.appendChild(dayField.label);
        rowDiv.appendChild(combinedCodeField.label); // Add combined code field
        rowDiv.appendChild(timeField.label);
        rowDiv.appendChild(airportField.label);
        rowDiv.appendChild(serviceField.label);
        return rowDiv;
    }


    /** Helper to create the standard SCR group UI element for NEW/CANCEL */
    function createScrGroupElement(outputList, airportCode, scrOutput) {
        const scrGroup = document.createElement("div");
        scrGroup.classList.add("scr-group");
        scrGroup.dataset.airportCode = airportCode;
        scrGroup.dataset.scrOutput = scrOutput; // Store the final string

        const headingDiv = document.createElement("div");
        headingDiv.classList.add("heading");
        headingDiv.textContent = `SCR [${airportCode}]`;

        const outputContainerDiv = document.createElement("div");
        outputContainerDiv.classList.add("output-container");
        const pre = document.createElement("pre");
        pre.textContent = scrOutput; // Display the final string
        outputContainerDiv.appendChild(pre);

        const sendButtonContainer = document.createElement("div");
        sendButtonContainer.classList.add("send-button-container");
        const sendBtn = document.createElement("button");
        sendBtn.textContent = "Send Email"; // Button for NEW/CANCEL
        sendButtonContainer.appendChild(sendBtn);

        scrGroup.appendChild(headingDiv);
        scrGroup.appendChild(outputContainerDiv);
        scrGroup.appendChild(sendButtonContainer);
        outputList.appendChild(scrGroup);
    }


    /**
     * Sends an email using mailto: link.
     * Uses encodeURIComponent() to ensure spaces become %20.
     */
    async function sendEmail(airportCode, scrOutput) {
      let subjectPrefix;
       if (currentSlotType === "NEW SLOT") subjectPrefix = "NEW SLOT REQ";
       else if (currentSlotType === "CANCEL SLOT") subjectPrefix = "SLOT CANX REQ";
       else if (currentSlotType === "CHANGE SCR") subjectPrefix = "SLOT CHG REQ";
       else subjectPrefix = "SLOT REQ"; // Fallback

      const subject = `${subjectPrefix} ${airportCode}`;

      const scrGroupElement = document.querySelector(`.scr-group[data-airport-code="${airportCode}"]`);
      let emailLookupServiceType = getSelectedServiceType(); // Default
      if (scrGroupElement && scrGroupElement.dataset.serviceType) {
          emailLookupServiceType = scrGroupElement.dataset.serviceType; // Use stored type for lookup
      }
      const recipientEmail = await getAirportEmail(airportCode, emailLookupServiceType);
      const ccEmail = "slotdesk@ryanair.com";

      // --- MANUAL URL ENCODING USING encodeURIComponent ---
      let mailtoLink = `mailto:${recipientEmail}`;
      const paramsArray = [];
       if (recipientEmail.toLowerCase() !== ccEmail.toLowerCase()) {
           paramsArray.push(`cc=${encodeURIComponent(ccEmail)}`);
       }
      paramsArray.push(`subject=${encodeURIComponent(subject)}`);
      paramsArray.push(`body=${encodeURIComponent(scrOutput)}`); // Encode body with %20 for spaces

      if (paramsArray.length > 0) {
          mailtoLink += `?${paramsArray.join('&')}`;
      }
      // --- END MANUAL ENCODING ---

       if (mailtoLink.length > 2000) {
           showError(`Email for ${airportCode} might be too long to open automatically. Please copy the text manually.`);
           console.warn("Mailto link potentially too long:", mailtoLink.length);
       }

      window.open(mailtoLink, '_blank');
      console.log(`Triggered mailto link for ${airportCode}. Using encodeURIComponent (spaces as %20). Link length: ${mailtoLink.length}`);
    }

    /**
     * Sends emails for all currently displayed SCR groups.
     * Uses increased delay and asks user to allow popups.
     */
    function sendAllEmails() {
      clearFeedback();
      const outputList = document.getElementById("outputList");
      const scrGroups = outputList.querySelectorAll(".scr-group");

      if (scrGroups.length === 0) {
        showError("No SCR messages displayed to send. Please format first.");
        return;
      }

      showSuccess(`Triggering ${scrGroups.length} email(s)... Please allow popups in your browser.`);

      let emailsSentCount = 0;
      const totalEmails = scrGroups.length;

      scrGroups.forEach((scrGroup, index) => {
        const airportCode = scrGroup.dataset.airportCode;
        const scrOutput = scrGroup.dataset.scrOutput; // Get the final string

        if (!airportCode || !scrOutput) {
          console.error("Skipping email: Missing airport code or SCR output on group element.", scrGroup);
          showError(`Error sending email for group ${index + 1}: Missing data.`);
          return;
        }

        setTimeout(async () => {
          try {
             // Rely on 'currentSlotType' being set correctly when 'format...' was last called for subject.
             await sendEmail(airportCode, scrOutput);
             emailsSentCount++;
             if (index === totalEmails - 1) { // Last iteration
                 setTimeout(() => {
                    if(emailsSentCount > 0) {
                       showSuccess(`Finished triggering ${emailsSentCount} / ${totalEmails} SCR emails.`);
                    }
                 }, 500);
             }
          } catch(err) {
              console.error(`Error sending email for ${airportCode} via Send All:`, err);
              showError(`Failed to trigger email for ${airportCode}.`);
          }
        }, index * 1500); // Use the increased delay
      });
    }


    // --- Event Listeners Setup ---
    function setupEventListeners() {
        document.getElementById("formatBtn").addEventListener("click", () => {
            const slotTypeValue = document.getElementById("slotType").value;
            if (slotTypeValue === "CHANGE") {
                formatChangeSCRMessages();
            } else {
                formatSCRMessages();
            }
        });

        document.getElementById("sendAllBtn").addEventListener("click", sendAllEmails);

        document.getElementById("dropdownMenu").addEventListener("change", function() {
            document.getElementById("aircraftSelection").style.display = (this.value === "D") ? "block" : "none";
        });

        const learjetCheckbox = document.getElementById("learjetCheckbox");
        const bombardierCheckbox = document.getElementById("bombardierCheckbox");

        learjetCheckbox.addEventListener("change", () => {
            if (learjetCheckbox.checked) {
                bombardierCheckbox.checked = false;
            } else if (!bombardierCheckbox.checked) {
                 learjetCheckbox.checked = true; // Prevent unchecking last box
            }
        });

        bombardierCheckbox.addEventListener("change", () => {
            if (bombardierCheckbox.checked) {
                learjetCheckbox.checked = false;
            } else if (!learjetCheckbox.checked) {
                bombardierCheckbox.checked = true; // Prevent unchecking last box
            }
        });
    }

    // --- Initialize ---
    document.addEventListener("DOMContentLoaded", () => {
        setupEventListeners();
        document.getElementById("aircraftSelection").style.display =
            (document.getElementById("dropdownMenu").value === "D") ? "block" : "none";
         attachSendButtonsListeners(); // Set up initial delegation listener
    });

</script>

</body>
</html>
